{% extends 'base.html' %}
{% block content %}
{% load static %}
<!-- Th√™m th∆∞ vi·ªán jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<link rel="stylesheet" href="{% static 'css/vocabulary.css' %}">
<div class="container">
    <audio id="correct-sound" src="{% static 'sound/correct.mp3' %}"></audio>
    <audio id="wrong-sound" src="{% static 'sound/error.mp3' %}"></audio>
    <audio id="click-sound" src="{% static 'sound/click.mp3' %}"></audio>

    <h1>Tra t·ª´ v·ª±ng</h1>
    <form id="wordForm">
        <label for="word_prefix">Nh·∫≠p t·ª´ b·∫°n mu·ªën t√¨m ki·∫øm:</label>
        <input type="text" id="word_prefix" name="word_prefix" placeholder="Nh·∫≠p t·ª´ t√¨m ki·∫øm..." required autocomplete="off">
    </form>

    <h2>K·∫øt qu·∫£ g·ª£i √Ω t·ª´:</h2>
    <ul id="suggestionsList">
        <!-- C√°c g·ª£i √Ω t·ª´ s·∫Ω ƒë∆∞·ª£c hi·ªÉn th·ªã ·ªü ƒë√¢y -->
    </ul>
</div>

<script>
    // L·∫Øng nghe s·ª± ki·ªán input v√†o √¥ t√¨m ki·∫øm
    $(document).ready(function() {
        $('#word_prefix').on('change', function() {
            var query = $(this).val();  // L·∫•y gi√° tr·ªã t·ª´ input

            if (query.length > 1) {  // Ch·ªâ t√¨m ki·∫øm khi chu·ªói c√≥ ƒë·ªô d√†i > 1 k√Ω t·ª±
                $.ajax({
                    url: '/vocabulary/search-suggestions/',  // ƒê·ªãa ch·ªâ endpoint API c·ªßa b·∫°n
                    data: { 'query': query },  // Truy·ªÅn t·ª´ kh√≥a t√¨m ki·∫øm
                    dataType: 'json',
                    success: function(data) {
                        console.log(data);  // Ki·ªÉm tra to√†n b·ªô d·ªØ li·ªáu tr·∫£ v·ªÅ t·ª´ server

                        // X√≥a h·∫øt k·∫øt qu·∫£ c≈© trong danh s√°ch g·ª£i √Ω
                        $('#suggestionsList').empty();

                        // N·∫øu c√≥ k·∫øt qu·∫£, hi·ªÉn th·ªã ch√∫ng
                        if (data.suggestions && data.suggestions.length > 0) {
                            data.suggestions.forEach(function(item) {
                                var suggestionItem = $('<li></li>').html(
                                    '<strong>' + item.word + '</strong><br>' +
                                    'Lo·∫°i t·ª´: ' + (item.description || 'Ch∆∞a c√≥') + '<br>' +
                                    'Chi ti·∫øt: ' + (item.detail_description || 'Ch∆∞a c√≥') + '<br>' +
                                    '<em>Phi√™n √¢m: ' + (item.phonetic || 'Ch∆∞a c√≥') + '</em><br>' +
                                    '√ù nghƒ©a: ' + (item.meaning || 'Ch∆∞a c√≥') + '<br>' +
                                    (item.example ? 'V√≠ d·ª•: ' + item.example : 'Kh√¥ng c√≥ v√≠ d·ª•') + '<br>' +
                                    '<button class="audio-btn" onclick="playAudio(\'' + item.word + '\')">üîä</button>' +
                                    '<button class="learn-word-btn" onclick="learnNewWord(\'' + item.word + '\')">H·ªçc t·ª´ n√†y </button>'
                                );
                                $('#suggestionsList').append(suggestionItem);
                            });
                        } else {
                            // N·∫øu kh√¥ng c√≥ k·∫øt qu·∫£ n√†o, hi·ªÉn th·ªã th√¥ng b√°o
                            $('#suggestionsList').append('<li>Kh√¥ng t√¨m th·∫•y t·ª´ n√†o kh·ªõp.</li>');
                        }
                    },
                    error: function() {
                        $('#suggestionsList').empty().append('<li>ƒê√£ c√≥ l·ªói x·∫£y ra. Vui l√≤ng th·ª≠ l·∫°i.</li>');
                    }
                });
            } else {
                $('#suggestionsList').empty();  // X√≥a g·ª£i √Ω khi input tr·ªëng
            }
        });
    });

    function playAudio(word) {
        $.ajax({
            url: '/vocabulary/read-text/',  // ƒê·∫£m b·∫£o URL n√†y ch√≠nh x√°c
            data: { 'text': word },  // G·ª≠i t·ª´ c·∫ßn ƒë·ªçc t·ªõi server
            dataType: 'json',
            success: function(response) {
                if (response.status === 'success') {
                    // C√≥ th·ªÉ th√™m h√†nh ƒë·ªông khi ƒë·ªçc th√†nh c√¥ng
                } else {
                    alert("C√≥ l·ªói khi ƒë·ªçc t·ª´: " + word + ". L·ªói: " + response.message);
                }
            },
            error: function(xhr, status, error) {
                alert('C√≥ l·ªói x·∫£y ra khi y√™u c·∫ßu ƒë·ªçc vƒÉn b·∫£n. Chi ti·∫øt l·ªói: ' + error);
            }
        });
    }

    function learnNewWord(word) {
        $.ajax({
            url: '/vocabulary/add-to-learning/',  // API x·ª≠ l√Ω th√™m t·ª´ v√†o danh s√°ch h·ªçc
            type: 'POST',
            data: JSON.stringify({ 'word': word }),  // G·ª≠i word
            contentType: 'application/json',
            success: function(response) {
                if (response.status === 'not_authenticated') {
                    // N·∫øu ch∆∞a ƒëƒÉng nh·∫≠p, hi·ªÉn th·ªã modal y√™u c·∫ßu ƒëƒÉng nh·∫≠p
                    showLoginModal();
                } else if (response.status === 'success') {
                    // N·∫øu th√™m t·ª´ th√†nh c√¥ng, hi·ªÉn th·ªã th√¥ng b√°o va ch·∫°y √¢m thanh
                    document.getElementById('correct-sound').play();
                    Swal.fire({
                        title: 'Th√†nh c√¥ng!',
                        text: `ƒê√£ th√™m t·ª´ "${word}" v√†o danh s√°ch h·ªçc.`,
                        icon: 'success',
                        showConfirmButton: false,
                        timer: 2000  // T·ª± ƒë·ªông ƒë√≥ng sau 3 gi√¢y
                    });
                } else {
                    // N·∫øu c√≥ l·ªói, hi·ªÉn th·ªã th√¥ng b√°o l·ªói v√† ch·∫°y √¢m thanh
                    document.getElementById('error-sound').play();
                    Swal.fire({
                        title: 'L·ªói!',
                        text: response.message,
                        icon: 'error',
                        confirmButtonText: 'OK'
                    });
                }
            },
            error: function() {
                Swal.fire({
                    title: 'L·ªói k·∫øt n·ªëi!',
                    text: 'Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi v√† th·ª≠ l·∫°i.',
                    icon: 'warning',
                    confirmButtonText: 'OK'
                });
            }
        });
    }
    
    
    // Hi·ªÉn th·ªã modal y√™u c·∫ßu ƒëƒÉng nh·∫≠p
    function showLoginModal() {
        let modalHTML = `
            <div id="loginModal" class="modal fade-out">
                <div class="modal-content">
                    <h2>B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ s·ª≠ d·ª•ng ch·ª©c nƒÉng n√†y!</h2>
                    <button onclick="window.location.href='{% url 'login' %}'">ƒêƒÉng nh·∫≠p</button>
                    <button onclick="closeModal()">H·ªßy</button>
                </div>
            </div>
        `;
        $('body').append(modalHTML);
        $('#loginModal').fadeIn().removeClass('fade-out').addClass('show');
        $('.modal-content').addClass('show');
    }

    // ƒê√≥ng modal
    function closeModal() {
        $('#loginModal').removeClass('show').addClass('fade-out').fadeOut(function() {
            $(this).remove();
        });
    }

    
</script>


{% endblock %}
