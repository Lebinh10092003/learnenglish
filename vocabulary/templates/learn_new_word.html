{% extends 'base.html' %}
{% block content %}
{% load static %}
<link rel="stylesheet" href="{% static 'css/vocabulary.css' %}">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<div class="container mt-5">
    <audio id="correct-sound" src="{% static 'sound/correct.mp3' %}"></audio>
    <audio id="wrong-sound" src="{% static 'sound/error.mp3' %}"></audio>
    <audio id="click-sound" src="{% static 'sound/click.mp3' %}"></audio>
    
    <div class="row">
        <!-- Menu b√™n tr√°i -->
        <div class="col-md-3">
            <h4>Ch·ªß ƒë·ªÅ</h4>
            <ul class="list-group" id="method-list-learning">
                <li class="list-group-item active" onclick="showMethod('word-list', this)">Danh s√°ch t·ª´ ƒëang h·ªçc</li>
                <li class="list-group-item" onclick="showMethod('learned', this)">Danh s√°ch t·ª´ ƒë√£ h·ªçc</li>
                <li class="list-group-item" onclick="showMethod('create-new-word', this)">Th√™m t·ª´ ri√™ng</li>
            </ul>
            <h4>Ph∆∞∆°ng ph√°p h·ªçc</h4>
            <ul class="list-group" id="method-list-methods">
                <li class="list-group-item" onclick="showMethod('flashcard', this)">Flashcard</li>
                <li class="list-group-item" onclick="showMethod('scramble', this)">S·∫Øp x·∫øp ch·ªØ c√°i</li>
                <li class="list-group-item" onclick="showMethod('fill', this)">ƒêi·ªÅn t·ª´ c√≤n thi·∫øu</li>

            </ul>
        </div>

        <!-- N·ªôi dung b√™n ph·∫£i -->
        <div class="col-md-9">
            <!-- Danh s√°ch t·ª´ ƒëang h·ªçc -->
            <div id="word-list-container" class="learning-method mt-3">
                <h5>Danh s√°ch t·ª´ ƒëang h·ªçc</h5>
                <div class="list-group">
                    {% for entry in user_vocabulary %}
                        <div class="list-group-item d-flex justify-content-between align-items-center" onclick="toggleWordDetails('word-{{ entry.vocabulary.id }}')">
                            <span>
                                <h5>{{ entry.vocabulary.word }}</h5> 
                                {{ entry.vocabulary.meaning }}</span>
                            <span class="badge badge-info">{{ entry.is_learned }}</span>
                            <div class="btn-group ml-2">
                                <a href="#" class="btn btn-primary btn-sm" onclick="markAsLearned({{ entry.id }})">Done</a>
                                <a href="#" class="btn btn-danger btn-sm mx-1" onclick="deleteWord({{ entry.id }})">Delete</a>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
            <!-- Danh s√°ch t·ª´ ƒë√£ h·ªçc -->
            <div id="learned-container" class="learning-method mt-3" style="display: none;">
                <h5>Danh s√°ch t·ª´ ƒë√£ h·ªçc</h5>
                <div class="list-group">
                    {% for entry in learned_words %}
                        <div class="list-group-item d-flex justify-content-between align-items-center" onclick="toggleWordDetails('word-{{ entry.vocabulary.id }}')">
                            <span>
                                <h5>{{ entry.vocabulary.word }}</h5> 
                                {{ entry.vocabulary.meaning }}</span>
                            </span>
                            <span class="badge badge-info">{{ entry.is_learned }}</span>
                            <div class="btn-group ml-2">
                                <a href="#" class="btn btn-warning btn-sm" onclick="markAsLearned({{ entry.id }})">Again</a>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
            <div id="create-new-word-container" class="learning-method mt-3" style="display: none;">
                <h5>Th√™m t·ª´ ri√™ng</h5>
                
                
            </div>

            <!-- Flashcard -->
            <div id="flashcard-container" class="learning-method mt-3" style="display: none;">
                <h5>Flashcard</h5>
                <div class="card text-center shadow-lg">
                    <div class="card-body">
                        <h5 class="card-title text-primary" id="flashcard-word" onclick="showMeaning()">Word</h5>
                        <p class="card-text text-muted" id="flashcard-meaning" style="display: none;">Meaning</p>
                    </div>
                </div>
                <button class="btn btn-success mt-3" onclick="fetchRandomWord('flashcard')">Next</button>
            </div>

            <!-- S·∫Øp x·∫øp ch·ªØ c√°i -->
            <div id="scramble-container" class="learning-method mt-3" style="display: none;">
                <h5>S·∫Øp x·∫øp c√°c ch·ªØ c√°i</h5>
                <div class="card p-3">
                    <p>Nh·∫≠p t·ª´ c√≥ c√°c ch·ªØ c√°i b·ªã x√°o tr·ªôn:</p>
                    <input type="text" id="scramble-input" class="form-control" placeholder="Nh·∫≠p t·ª´" autocomplete="off">
                    <button class="btn btn-primary mt-2" onclick="checkScramble()">Ki·ªÉm tra</button>
                </div>
                <!-- Hi·ªÉn th·ªã t·ª´ ƒë√£ x√°o tr·ªôn v√† nghƒ©a -->
                <div id="scramble-word-container" class="mt-2">
                    <p><strong>S·∫Øp x·∫øp l·∫°i:</strong> <span id="scrambled-word" class="text-muted"></span></p>
                    <p><strong>Nghƒ©a:</strong> <span id="scrambled-meaning" class="text-muted"></span></p>
                </div>
            </div>

            <!-- ƒêi·ªÅn t·ª´ c√≤n thi·∫øu -->
            <div id="fill-container" class="learning-method mt-3" style="display: none;">
                <h5>ƒêi·ªÅn t·ª´ c√≤n thi·∫øu</h5>
                <div class="card p-3">
                    <p>ƒêi·ªÅn v√†o t·ª´ c√≤n thi·∫øu:</p>
                    <input type="text" id="fill-input" class="form-control" placeholder="Nh·∫≠p t·ª´" autocomplete="off">
                    <button class="btn btn-primary mt-2" onclick="checkFill()">Ki·ªÉm tra</button>
                </div>
                <!-- Hi·ªÉn th·ªã t·ª´ c√≥ kho·∫£ng tr·ªëng v√† nghƒ©a -->
                <div id="fill-word-container" class="mt-2">
                    <p><strong>ƒêi·ªÅn t·ª´ c√≤n thi·∫øu:</strong> <span id="masked-word" class="text-muted"></span></p>
                    <p><strong>Nghƒ©a:</strong> <span id="masked-meaning" class="text-muted"></span></p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function showMethod(method, element) {
    // ·∫®n t·∫•t c·∫£ c√°c ph∆∞∆°ng ph√°p h·ªçc v√† hi·ªÉn th·ªã ph·∫ßn t∆∞∆°ng ·ª©ng
    document.querySelectorAll(".learning-method").forEach(el => el.style.display = "none");
    document.getElementById(method + "-container").style.display = "block";

    // C·∫≠p nh·∫≠t l·ªõp "active"
    document.querySelectorAll("#method-list-learning .list-group-item").forEach(el => el.classList.remove("active"));
    document.querySelectorAll("#method-list-methods .list-group-item").forEach(el => el.classList.remove("active"));
    element.classList.add("active");

    // Danh s√°ch ph∆∞∆°ng ph√°p c·∫ßn l·∫•y t·ª´ m·ªõi
    const methodsRequiringWords = ["flashcard", "scramble", "fill"];
    
    if (methodsRequiringWords.includes(method)) {
        fetchRandomWord(method);
    }
}    
// ƒê·∫£m b·∫£o "Danh s√°ch t·ª´ ƒëang h·ªçc" ƒë∆∞·ª£c hi·ªÉn th·ªã m·∫∑c ƒë·ªãnh
document.addEventListener("DOMContentLoaded", function() {
    showMethod('word-list', document.querySelector("#method-list-learning .list-group-item"));
});

function toggleWordDetails(wordId) {
    const wordElement = document.getElementById(wordId);
    const meaningElement = wordElement.querySelector('.card-text');

    // Ki·ªÉm tra v√† ·∫©n/hi·ªán nghƒ©a
    if (meaningElement.style.display === "none") {
        meaningElement.style.display = "block";  // Hi·ªÉn th·ªã nghƒ©a
    } else {
        meaningElement.style.display = "none";  // ·∫®n nghƒ©a
    }
}

// ƒê√°nh d·∫•u t·ª´ ƒë√£ h·ªçc
const randomWordUrl = "{% url 'random-word' %}";

function showAlert(icon, title, text) {
    Swal.fire({
        icon: icon,
        title: title,
        text: text,
        showConfirmButton: false,
        timer: 2000
    });
}

// L·∫•y t·ª´ m·ªõi t·ª´ API v√† x·ª≠ l√Ω c√°c ph∆∞∆°ng ph√°p h·ªçc
function fetchRandomWord(method) {
    fetch(randomWordUrl)
        .then(response => response.json())
        .then(data => {
            console.log("D·ªØ li·ªáu API tr·∫£ v·ªÅ:", data);  // Debug d·ªØ li·ªáu API

            // Ki·ªÉm tra n·∫øu d·ªØ li·ªáu tr·∫£ v·ªÅ h·ª£p l·ªá
            if (!data || !data.word) {
                showAlert("error", "L·ªói!", "D·ªØ li·ªáu API kh√¥ng h·ª£p l·ªá.");
                return;
            }

            // C·∫≠p nh·∫≠t t·ª´ v√† nghƒ©a v√†o giao di·ªán
            const word = data.word;
            const meaning = data.meaning || "Kh√¥ng c√≥ nghƒ©a.";

            // Flashcard
            document.getElementById("flashcard-word").innerText = word;
            document.getElementById("flashcard-meaning").innerText = meaning;
            document.getElementById("flashcard-meaning").style.display = "none";

            // S·∫Øp x·∫øp ch·ªØ c√°i
            let scrambledWord = shuffleWord(word);
            document.getElementById("scramble-input").value = "";
            document.getElementById("scramble-input").setAttribute("data-answer", word);
            document.getElementById("scramble-word-container").querySelector("#scrambled-word").innerText = scrambledWord;
            document.getElementById("scramble-word-container").querySelector("#scrambled-meaning").innerText = meaning;

            // ƒêi·ªÅn t·ª´ c√≤n thi·∫øu
            let missingWord = maskWord(word);
            document.getElementById("fill-input").value = "";
            document.getElementById("fill-input").setAttribute("data-answer", word);
            document.getElementById("fill-word-container").querySelector("#masked-word").innerText = missingWord;
            document.getElementById("fill-word-container").querySelector("#masked-meaning").innerText = meaning;

            // Hi·ªÉn th·ªã ph∆∞∆°ng ph√°p h·ªçc t∆∞∆°ng ·ª©ng
            document.querySelectorAll(".learning-method").forEach(el => el.style.display = "none");
            document.getElementById(`${method}-container`).style.display = "block";
        })
        .catch(error => {
            console.error('L·ªói khi l·∫•y t·ª´ m·ªõi:', error);
            showAlert("error", "L·ªói!", "Kh√¥ng th·ªÉ l·∫•y t·ª´ m·ªõi. Vui l√≤ng th·ª≠ l·∫°i!");
        });
}

// Ki·ªÉm tra ƒë√°p √°n ph∆∞∆°ng ph√°p "S·∫Øp x·∫øp ch·ªØ c√°i"
function checkScramble() {
    let correctAnswer = document.getElementById("scramble-input").getAttribute("data-answer");
    checkAnswer("scramble-input", correctAnswer, "scramble");
}

// Ki·ªÉm tra ƒë√°p √°n ph∆∞∆°ng ph√°p "ƒêi·ªÅn t·ª´ c√≤n thi·∫øu"
function checkFill() {
    let correctAnswer = document.getElementById("fill-input").getAttribute("data-answer");
    checkAnswer("fill-input", correctAnswer, "fill");
}


// Ki·ªÉm tra ƒë√°p √°n chung
function checkAnswer(inputId, correctAnswer, method) {
    let userInput = document.getElementById(inputId).value.trim();
    if (userInput.toLowerCase() === correctAnswer.toLowerCase()) {
        showAlert("success", "Ch√≠nh x√°c!", "B·∫°n ƒë√£ tr·∫£ l·ªùi ƒë√∫ng üéâ");
        setTimeout(() => fetchRandomWord(method), 1500);
        document.getElementById('correct-sound').play();
    } else {
        showAlert("error", "Sai r·ªìi!", `ƒê√°p √°n ƒë√∫ng l√†: ${correctAnswer}`);
        document.getElementById('wrong-sound').play();
    }
}

// X√°o tr·ªôn th·ª© t·ª± ch·ªØ c√°i trong t·ª´
function shuffleWord(word) {
    return word.split("").sort(() => Math.random() - 0.5).join("");
}

// ·∫®n ng·∫´u nhi√™n m·ªôt s·ªë k√Ω t·ª± trong t·ª´
function maskWord(word) {
    let chars = word.split("");
    let maskCount = Math.max(1, Math.floor(chars.length / 3));
    for (let i = 0; i < maskCount; i++) {
        let randIndex = Math.floor(Math.random() * chars.length);
        chars[randIndex] = "_";
    }
    return chars.join("");
}

// Hi·ªÉn th·ªã nghƒ©a c·ªßa t·ª´ trong Flashcard
function showMeaning() {
    var meaningElement = document.getElementById("flashcard-meaning");
    if (meaningElement.style.display === "none") {
        meaningElement.style.display = "block";  // Hi·ªÉn th·ªã nghƒ©a khi b·∫•m v√†o t·ª´
    } else {
        meaningElement.style.display = "none";  // ·∫®n nghƒ©a khi b·∫•m l·∫°i
    }
}

const updateLearningStatusUrl = "{% url 'update-learning-status' 0 %}";
function markAsLearned(wordId) {
    let url = updateLearningStatusUrl.replace("0", wordId); // Thay s·ªë 0 b·∫±ng ID th·∫≠t
    $.ajax({
        url: url, 
        type: 'GET',
        success: function(response) {
            console.log("C·∫≠p nh·∫≠t th√†nh c√¥ng", response);

            // C·∫≠p nh·∫≠t tr·ª±c ti·∫øp UI
            let badge = $(`#word-${wordId} .badge`);
            if (response.is_learned === "Learned") {
                badge.text("Learned").removeClass("badge-info").addClass("badge-success");
            } else {
                badge.text("Learning").removeClass("badge-success").addClass("badge-info");
            }

            // Hi·ªÉn th·ªã th√¥ng b√°o th√†nh c√¥ng
            showAlert('success', 'C·∫≠p nh·∫≠t th√†nh c√¥ng', 'Tr·∫°ng th√°i h·ªçc c·ªßa t·ª´ ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t!');

            // T·∫£i l·∫°i to√†n b·ªô danh s√°ch t·ª´ ƒëang h·ªçc
            $('#word-list-container').load(location.href + ' #word-list-container > *', function() {
                // Sau khi t·∫£i l·∫°i, th√™m c√°c ph·∫ßn t·ª≠ m·ªõi v√†o danh s√°ch n·∫øu c·∫ßn
                console.log("Danh s√°ch t·ª´ ƒëang h·ªçc ƒë√£ ƒë∆∞·ª£c t·∫£i l·∫°i.");
                document.getElementById('correct-sound').play();
            });
            // N·∫øu tr·∫°ng th√°i t·ª´ ƒë√£ h·ªçc, di chuy·ªÉn t·ª´ n√†y v√†o danh s√°ch t·ª´ ƒë√£ h·ªçc
            if (response.is_learned === "Learned") {
                // Di chuy·ªÉn t·ª´ n√†y v√†o danh s√°ch t·ª´ ƒë√£ h·ªçc
                let learnedWord = $(`#word-${wordId}`).clone();
                $('#learned-container .list-group').append(learnedWord);  // Th√™m t·ª´ v√†o danh s√°ch ƒë√£ h·ªçc

                // X√≥a t·ª´ kh·ªèi danh s√°ch t·ª´ ƒëang h·ªçc
                $(`#word-${wordId}`).remove();
            }


            // T·∫£i l·∫°i to√†n b·ªô danh s√°ch t·ª´ ƒë√£ h·ªçc
            $('#learned-container').load(location.href + ' #learned-container > *', function() {
                // Sau khi t·∫£i l·∫°i, th√™m c√°c ph·∫ßn t·ª≠ m·ªõi v√†o danh s√°ch n·∫øu c·∫ßn
                console.log("Danh s√°ch t·ª´ ƒë√£ h·ªçc ƒë√£ ƒë∆∞·ª£c t·∫£i l·∫°i.");
                document.getElementById('correct-sound').play();
            });
        },
        error: function(xhr) {
            console.error("L·ªói c·∫≠p nh·∫≠t:", xhr.responseText);

            // Hi·ªÉn th·ªã th√¥ng b√°o l·ªói
            showAlert('error', 'L·ªói c·∫≠p nh·∫≠t', 'ƒê√£ c√≥ l·ªói x·∫£y ra khi c·∫≠p nh·∫≠t tr·∫°ng th√°i h·ªçc. Vui l√≤ng th·ª≠ l·∫°i!');
            document.getElementById('error-sound').play();
        }
    });
}

const deleteWordUrl = "{% url 'delete-learning-word' 0 %}";

function deleteWord(wordId) {
    // S·ª≠ d·ª•ng SweetAlert2 ƒë·ªÉ hi·ªÉn th·ªã h·ªôp tho·∫°i x√°c nh·∫≠n
    Swal.fire({
        title: 'B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a t·ª´ n√†y kh√¥ng?',
        text: "H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        confirmButtonText: 'X√≥a',
        cancelButtonText: 'H·ªßy'
    }).then((result) => {
        // N·∫øu ng∆∞·ªùi d√πng nh·∫•n "X√≥a", th·ª±c hi·ªán y√™u c·∫ßu AJAX
        if (result.isConfirmed) {
            let url = deleteWordUrl.replace("0", wordId); // Thay s·ªë 0 b·∫±ng ID th·∫≠t
            $.ajax({
                url: url, 
                type: 'GET',
                success: function(response) {
                    console.log("X√≥a th√†nh c√¥ng", response);

                    // X√≥a t·ª´ kh·ªèi danh s√°ch h·ªçc
                    $(`#word-${wordId}`).remove();

                    // Hi·ªÉn th·ªã th√¥ng b√°o th√†nh c√¥ng
                    showAlert('success', 'X√≥a th√†nh c√¥ng', 'T·ª´ ƒë√£ ƒë∆∞·ª£c x√≥a kh·ªèi danh s√°ch h·ªçc!');
                    document.getElementById('correct-sound').play();

                    // N·∫øu c·∫ßn, c√≥ th·ªÉ t·∫£i l·∫°i c√°c ph·∫ßn t·ª≠ danh s√°ch
                    $('#word-list-container').load(location.href + ' #word-list-container > *', function() {
                        console.log("Danh s√°ch t·ª´ ƒëang h·ªçc ƒë√£ ƒë∆∞·ª£c t·∫£i l·∫°i.");
                    });
                },
                error: function(xhr) {
                    console.error("L·ªói x√≥a t·ª´:", xhr.responseText);

                    // Hi·ªÉn th·ªã th√¥ng b√°o l·ªói
                    showAlert('error', 'L·ªói x√≥a t·ª´', 'ƒê√£ c√≥ l·ªói x·∫£y ra khi x√≥a t·ª´. Vui l√≤ng th·ª≠ l·∫°i!');
                    document.getElementById('error-sound').play();
                }
            });
        } else {
            console.log("Ng∆∞·ªùi d√πng ƒë√£ h·ªßy h√†nh ƒë·ªông x√≥a.");
        }
    });
}


</script>
{% endblock %}
